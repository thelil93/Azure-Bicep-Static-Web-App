# Static Web App Deployment (with [HUGO](https://gohugo.io/) defaults) - Azure Bicep 

Take your Hugo-based site from your GitHub repository and host it on Microsoft Azure, with an optional custom domain and SSL certificate **For free**.

## Usage

### Prerequisites

Before you begin, ensure you have the following:

- An Azure subscription.
- Azure CLI installed. [How to install](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli)
- Existing resources such as DNS zone if applicable.
- GitHub repository URL and personal access token.

### Steps

1. Clone this repository or download the files to your local machine.

2. Customize the parameters in the parameters file as needed: (`staticWebAppDeployment.parameters.bicepparam`)

   - `paramSiteName`: Part of the name of the static web app resource (up to 15 characters long).
   - `paramEnvironment`: The name of the environment (e.g., "dev", "test", "prod", up to 4 characters long).
   - `paramLocation`: The Azure region where the resources will be deployed.
   - `paramCustomDomain`: The domain name for the deployed application.
   - `paramSubDomain`: The subdomain that the deployed application will be accessed by.
   - `paramRepositoryUrl`: The URL to your application repository.
   - `paramRepositoryToken`: Your GitHub personal access token.
  
> **Note:** `paramCustomDomain` and `paramSubDomain` should only be changed if you [host your domain in Azure DNS](https://learn.microsoft.com/en-us/azure/dns/dns-delegate-domain-azure-dns) and have followed the steps in the [Custom domain](#custom-domain) section below. Keep the default values to deploy an app with an auto-generated domain name.

3. Save your changes.

4. Open a terminal and navigate to the directory containing the Bicep file.

5. Deploy the Bicep template using the following command where `name` is the name of the deployment and `location` is the Azure region that your resources will be deployed to

   ```bash
   az deployment sub create -n name -l location -f staticWebAppDeployment.bicep -p staticWebAppDeployment.parameters.bicepparam
   ```
### Custom domain
To deploy your static web app with a custom domain, make sure you:

1. Have the permissions to add records in your dns-zone (the zone does not have to be in the same subscription as you are deploying to)
2.  Add your domain in `existingResources.json`, formatted as shown:

    ```JSON
        "domains":{
            "example.com":{
                "resourceGroup": "azure-resourcegroup-name",
                "subscription": "azure-subscription-id",
                "domain": "example.com"          
            },
            "your-custom-domain.com":{
                "resourceGroup": "your-custom-domain-resourcegroup",
                "subscription": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
                "domain": "your-custom-domain.com"
            }
        }
    ```

3. Edit the parameters `paramCustomDomain` and `paramSubDomain` in the parameters file `staticWebAppDeployment.parameters.bicepparam`:

    ```YAML
    param paramCustomDomain = 'your-custom-domain.com'
    param paramSubDomain = 'your-subdomain'
    ```
### Optional parameters and defaults

In the main deployment file `staticWebAppDeployment.bicep` there are a number of optional parameters. You can declare and customize all, none or any number of them in the parameters file before deployment and they will be consumed by the module `staticWebApp.bicep`. The defaults are configured in the module itself and their default values are setup to deploy a free static web app that is generated by [HUGO](https://gohugo.io/) and stored in a GitHub repository.

- `paramRepositoryBranch`: The branch of your repository you want to deploy. Defaults to `main`.
- `paramAppLocation`: Your app source code path. Defaults to `/`.
- `paramApiLocation`: Your optional API source code path. Defaults to " ".
- `paramAppArtifactLocation`: Your optional built app content directory. Defaults to `public`.
- `paramSku`: Choice of hosting plan tier for the static web app. Defaults to `Free`.
- `paramSkuCode`: Name of hosting plan tier for the static web app. Defaults to `Free`.

## Limitations

### Apex domains not supported when deploying with Bicep

Azure DNS does not allow you to set an empty value or a single '@' character for a CNAME record. This means that you have to use a different validation method when deploying a custom domain for a static site.<br>
As per the [Microsoft documentation](https://learn.microsoft.com/en-us/azure/static-web-apps/apex-domain-azure-dns), you need to set a TXT record to validate domain ownership. This validation method is supported by the resource type [Microsoft.Web/staticSites/customDomains](https://learn.microsoft.com/en-us/azure/templates/microsoft.web/staticsites/customdomains?pivots=deployment-language-bicep) by setting the property:

```YAML
  properties: {
    validationMethod: 'dns-txt-token'
  }
```

However, it is the deployment of this resource that generates the validation token that you need as a value for your TXT record, and since this deployment does not finish if the domain is not validated, it is impossible to use the output from it in subsequent modules.